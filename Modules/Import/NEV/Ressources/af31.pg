CREATE OR REPLACE FUNCTION FCTCREATEaf31(CSVFILE text) RETURNS integer
AS $$
DECLARE af31exists BOOLEAN;
BEGIN
        SELECT EXISTS into af31exists (
           SELECT FROM information_schema.tables
           WHERE  table_schema = 'public'
           AND    table_name   = 'af31'
        );

        if af31exists then
           drop table af31;
        end if;
        
        CREATE TABLE public.af31
            (
            cddate date,
cdchrono text,
cdindex text,
cdduplicle text,
cdactivite text,
cdlabo text,
cdtyplabo text,
cdetat text,
cdheure text,
cdminute text,
cdtypcde text,
cdctxoctroimer text,
cdachcat varchar(200),
cdachrem varchar(200),
cdnblignes text,
cdboites text,
cdspeciale text,
cdrefcc text,
cdnetpropose text,
cdarchive text,
cdcdecadence text,
cdtypecadence text,
cdapriori text,
cdrecmulticde text,
cddatetrans text,
cdheuretrans text,
cdminutetrans text,
cddatelivr date,
cdheurelivr text,
cdminutelivr text,
cdvendeur text,
cdeuro text,
cdgronum text,
cddatetltprev text,
cdheuretltprev text,
cdminutetltprev text,
cdtltauto text,
cdstatustlt text,
cdsensmvt text,
cddatedebper date,
cddatefinper date,
cdremex text,
cdtypremex text,
cdescompte text,
cdtypescompte text,
cdfraisport text,
cdtypfrais text,
cdmtug text,
cdnbug text,
cdtxremfact text,
cdmtremfact text,
cdrevient text,
cdpnttpv text,
cdtypavoir text,
cdartetat text,
cdart text,
cdartligne text,
cdpremlivrais text,
cddernlivrais text,
cddatcloture text,
cdnblivrais text,
cdcdegroupe text,
cdnumgroupe text,
cdnummembre text,
cdreccd text,
cdpmlstatus text,
cdplabstatus text,
cdversion text,
cdmtoctroimer text,
cdmapnumcdegen text,
cdmapnumcdeind text,
cdcrit_eclat text,
cdcode_offre text,
cdbon_liv text,
cdbon_liv_valorise text,
cdspecifique text,
cdmodevalid_nego text,
cddatevalidation date,
cddatevalorisation date,
cdref_fourn text,
cdgrprecmulticde text,
cdcomconfrere text,
cdcrossnocde text,
cdhistosansmajpx text,
updated_at text,
cdmaptypecde text,
cdmappasmajpx text,
cdclefcdecadence_date text,
cdclefcdecadence_chrono text,
cdnature_prix text,
                CONSTRAINT af31_pkey PRIMARY KEY (cddate, cdchrono)
            )
            WITH (
                OIDS = FALSE
            )
            TABLESPACE pg_default;

        execute 'COPY af31(
            cddate,
cdchrono,
cdindex,
cdduplicle,
cdactivite,
cdlabo,
cdtyplabo,
cdetat,
cdheure,
cdminute,
cdtypcde,
cdctxoctroimer,
cdachcat,
cdachrem,
cdnblignes,
cdboites,
cdspeciale,
cdrefcc,
cdnetpropose,
cdarchive,
cdcdecadence,
cdtypecadence,
cdapriori,
cdrecmulticde,
cddatetrans,
cdheuretrans,
cdminutetrans,
cddatelivr,
cdheurelivr,
cdminutelivr,
cdvendeur,
cdeuro,
cdgronum,
cddatetltprev,
cdheuretltprev,
cdminutetltprev,
cdtltauto,
cdstatustlt,
cdsensmvt,
cddatedebper,
cddatefinper,
cdremex,
cdtypremex,
cdescompte,
cdtypescompte,
cdfraisport,
cdtypfrais,
cdmtug,
cdnbug,
cdtxremfact,
cdmtremfact,
cdrevient,
cdpnttpv,
cdtypavoir,
cdartetat,
cdart,
cdartligne,
cdpremlivrais,
cddernlivrais,
cddatcloture,
cdnblivrais,
cdcdegroupe,
cdnumgroupe,
cdnummembre,
cdreccd,
cdpmlstatus,
cdplabstatus,
cdversion,
cdmtoctroimer,
cdmapnumcdegen,
cdmapnumcdeind,
cdcrit_eclat,
cdcode_offre,
cdbon_liv,
cdbon_liv_valorise,
cdspecifique,
cdmodevalid_nego,
cddatevalidation,
cddatevalorisation,
cdref_fourn,
cdgrprecmulticde,
cdcomconfrere,
cdcrossnocde,
cdhistosansmajpx,
updated_at,
cdmaptypecde,
cdmappasmajpx,
cdclefcdecadence_date,
cdclefcdecadence_chrono,
cdnature_prix
        )
            from ''' || $1 || '''
            DELIMITER '';''
            CSV HEADER';

            return 0;
END;
$$ 
LANGUAGE PLPGSQL;
