select 
prd.pnocip,
prd.pcip || prd.pclefcip cip, 
prd.pclebcb,
prd.plibelle,
prd.pean13,
prd.pfamille,
null familleinteerne,
prd.plabo,
prd.pdistri,
prd.pcode,
prd.prepart,
prd.ptableau,
prd.ppxbaserembt,
prd.ppxpublic,
prd.pcodetva,
act.tab_zon[1],
prd.ppxachat,
prd.ppxach2,
prd.preserve,
prd.pautomate,
prd.pclasseforcee codegestion,
prd.putimaxforce forcee,
prd.pcodegeo, 
prd.pgeoreserve,
prd.pstoprot,
case when prd.putiprotforce ='O' then prd.pstoprotforce else null end,
case when prd.putimaxforce='O' and prd.pstomax>prd.pstoprotforce then prd.pstomax else null end,
prd.pstomirayon,
prd.pstomarayon,
prd.pstockrayon,
prd.pstockres,
prd.pdernpxremise,
prd.pdatven[1],
prd.pperime,
prd.ploctarif,
prd.pallopathie,
( select array_to_string(array_agg(comv.notptexte), chr(13) ) from afnotap comv where comv.notpcip = prd.pnocip and comv.notptype = 'V' group by notpcip, notptype ), 
( select array_to_string(array_agg(coma.notptexte), chr(13) ) from afnotap coma where coma.notpcip = prd.pnocip and coma.notptype = 'A' group by notpcip, notptype ) 
from public.afb1 prd  
left join afztab act on (act.tab_codtab = 'ACTSV' and act.tab_codent = '0000'|| prd.pnature )